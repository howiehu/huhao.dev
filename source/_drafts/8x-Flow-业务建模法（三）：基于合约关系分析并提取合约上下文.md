---
title: 8x Flow 业务建模法（三）：基于合约关系分析并提取合约上下文
abbrlink: eda54f7
categories:
  - 软件工程实践
tags:
  - 业务建模
  - 8x Flow
  - 业务逻辑
---

## 前言

在上一篇[《8x Flow 业务建模法（二）：再看什么是业务逻辑》](/posts/a7c771dd/)中，我们对于什么是业务逻辑进行了再一次的说明和澄清，在这里回顾一下业务逻辑的关键特征：

> - **业务逻辑关注的是如何盈利的特定运营流程，对外关注的是如何通过提供商品或服务盈利，对内关注的是如何控制成本结构和绩效。**
> - **业务流程即业务凭证的追溯过程，业务凭证不可变且不可抛弃。**
> - **在现实中，业务活动作为企业运营的一部分，客观存在且受到合同法的保护，业务逻辑即合同范围内甲乙双方权责的履约过程。**

同时我们也再一次强调了业务逻辑的客观存在性：

> **业务逻辑具有天然的基于合约的法律约束，这一点是现实中的客观事实。领域逻辑则往往不涉及合同法的约束。**

另外，基于**“业务逻辑即合同范围内甲乙双方权责的履约过程“**这一特征，我们在上一篇中给出过一个围绕从合约产生到履约过程的一个抽象模型，即`合约上下文（Contract Context）模型`：

> `Request for Proposal` → `Proposal` → `Contract` → `Fulfillment Request` → `Fulfillment Confirmation`

模型的图像关系如下：

![合约上下文模型](https://huhao-dev.oss-cn-beijing.aliyuncs.com/合约上下文模型-2021-04-04-16-54-59.png)

同时，我们也对该模型，也就是合约上下文的关键活动过程（逻辑关系）做过解释：

> 1. 甲方先要进行`方案征询（Request for Proposal，简称RFP）`，然后乙方给出`提案（Proposal）`，随后双方根据方案的一致认同签订`合约（Contract）`。
> 2. 合约签订之后，双方就会根据合约中的权责条款进行逐项`履约（Fulfillment）`。
> 3. 每次履约实际上分成了两类，一个是`履约申请（Fulfillment Request）`，一个是`履约确认（Fulfillment Confirmation）`，分别由甲乙双方的其中一方执行，其中履约申请是一个时间段，而履约确认是一个或多个时间点（因为履约总是需要个过程，不可能瞬间完成）。
> 4. 其中的`RFP、Proposal`、`Contract`、`Fulfillment Request`、`Fulfillment Confirmation`，都是`凭证（Evidence）`，所以是需要留存和可追溯的。

基于以上的业务逻辑相关知识，我们从本篇开始，将逐渐进入8x Flow的业务分析和建模方法介绍。

本篇说的就是8x Flow的第一步：**分析并提取合约上下文（Contract Context）**。

<!-- more -->

## 合约的概念

在我们开始业务分析和建模之前，非常有必要先审视一下**合约**的概念。

### 什么是合约？

在这里，**当我们说到“合约”这个词的时候，目的是消除语言的二义性**，在现实的法务定义中，依据法律约束力的由弱至强，可以分为：

> - 协议（Agreement）：双方就业务安排中的权利和责任达成的一致理解。
> - 合同（Contract）：双方之间签署的具有法律约束力的协议（Agreement）。

换句话说：**合同（Contract）是一种特定类型的协议（Agreement），必要时可在法院强制执行。**

**不论是协议还是合同，一旦其发生了变更，都需要合同双方重新予以确认，以便达成新的业务权责关系，不同版本的协议和合同也代表了不同历史时期的业务**——这也是为什么我们在使用一些网站或APP的时候，过一段时间就会提醒某种协议变更，只有同意后才能继续使用的原因——因为业务中的某种权责关系发生了变化。（此外，因为往往这些是协议而不是合同，所以大多数只需勾选同意，而非签署正式合同，或做合同变更。）

***PS：在文章中，当不涉及需要精准表达的场景中（例如建模时的命名），我们会继续使用中文的“合约”一词代替“合同”或“协议”，从而统一语言。***

### 合约上都有什么？

合约上都有怎样的关键信息呢？我们用一个大家可能相对比较熟悉的房屋租赁合同来举例（这里用了一个较为严谨和规范的例子，由于受图片尺寸限制只能截取片段，完整版请见：[《深圳市房屋租赁合同书（住宅）》](http://zjj.sz.gov.cn/xxgk/tzgg/content/post_6564773.html)）：

![深圳市房屋租赁合同书（住宅）片段](https://huhao-dev.oss-cn-beijing.aliyuncs.com/深圳市房屋租赁合同书（住宅）-2021-04-18-13-25-38.png)

在众多法务用语和文字之中，有这样一些需要我们关注的关键的信息：

1. **当事人（Partis）**，即常说的甲乙方，限定了合同所涉及的自然人或法律实体（但需要注意的是甲乙方在法律意义上是平等的，并没有“甲方就是客户爸爸，乙方就是万年跪着”之说……）。如果是多方合约，在法律上都是看做两两构成的双方合约。
2. **条款（Clauses）**，描述了双方的权责关系和履约方式，还有一些履约所需要的关键信息，通常是：钱、时间、次数、物品、标准、场所……等等。条款所涉及的履约过程和活动，都应通过**凭证（Evidences）**进行证明和留存，并可通过凭证进行追溯。
3. **违约（Breach of Contract）**，描述了当发生违约之后双方的处理方式，同样是通过条款来进行细化，从业务分析和建模的角度来讲，往往容易被忽视，从而造成法律风险。

**了解并学习合同知识，目的是为了我们基于业务的法律属性和权责关系，更好的理解、梳理并设计出更加严谨和合理的业务，或者寻找业务设计上可能存在的权责不匹配所造成的业务或法务漏洞。**从不同的角色来看：

- 对于一个法务人员来说，如果能够非常清晰地知道以上知识，则能够制定更加严谨的合同文本。
- 对于一个业务人员来说，如果能够非常清晰地知道以上知识，则能够设计更严谨和合理的业务。
- 对于一个技术人员来说，如果能够非常清晰地知道以上知识，则能够更好地理解业务，并设计出更加符合业务要求的软件。

而我们接下来要进行的**8x Flow业务分析和建模过程的核心，就是关注并着重分析以上关键信息之间的逻辑关系和合理性，通过提取、分类、组合和抽象这些关键信息来实现的**。

## 合约关系 over 合约文件

然而，需要注意的是：**在现实中，我们通常不太可能完全基于真实的合同或协议文件进行业务分析和建模。**主要原因是：

1. 真实的合约受限于编写者的认知水平和专业水平，合约编写的严谨程度会有不同，内容和实际业务可能存在差异，而且出于某些特殊原因，合约的内容可能存在一定的灰度地带。
2. 企业的业务部门和法务部门相互独立，法务部门更多的是为业务部门的业务设计提供法律保障，虽然合约上的条款反映了实际业务，但是合约毕竟不是业务说明书，文本的应用场景不同，所以仅供作为一种关键的业务输入。 
3. 一份合约，往往是一份当事人双方权责关系的大集合，其中的权责关系还可以依据上下文相关性被进一步细化分类。
4. 在当事人双方的组织内部，当业务被落实到不同的部门的时候，实际上部门之间的合作也可被视为具有相应的权责内容和履约活动，这些隐性的合约关系，往往是天然存在但没有现成的合约文件来呈现的（可以想象一下跨部门合作中的日常掰扯，实际上就是权责关系的体现）。

（待完成）

- 合约文件
- 合约关系
- 业务凭证

## 基于合约关系分析并提取合约上下文

在了解了必要的合约知识，以及合约关系的概念之后，我们基于大家日常接触比较多的订餐平台的业务，来讲一讲如何基于合约关系分析和提取合约上下文。

通常来讲，**在现实中我们都应基于现有合约内容分析已有业务，或者基于合约的思想设计新的业务**，但是真正的订餐业务是非常复杂的，合约的内容也非常的多。**为了便于写文章，下面我会给出一个经过简化的订餐平台业务进行说明，而非采用真实的合约文本**。

如果你想了解真正的订餐类业务，可以参考一下“饿了么”或其它类似产品的相关合约文件（如果你是通过微信公众号阅读本文，可以点击末尾左下角的阅读原文来访问链接）：

- [《饿了么用户服务协议》](https://render.alipay.com/p/f/fd-jb2xbzcl/index.html)
- [《饿了么网上订餐平台服务协议》](https://kaidian.ele.me/contract)
- [《饿了么蜂鸟众包配送协议》](https://talaris-h5.ele.me/agreement/agreement.html)

### 业务说明（参考）

*（PS：该案例纯用于文章写作，并不保证业务完备性，如有类同，纯属巧合。）*

**某互联网订餐平台——“吃了么”（简称：平台），寻找供应商协助完成产品开发**，通过手机APP（iOS、Android）、微信小程序、Web应用作为用户触点，达成其业务目标。该公司对该产品有如下期望（图文无关）：

![吃了么（图文无关）-2021-05-01-00-33-17](https://huhao-dev.oss-cn-beijing.aliyuncs.com/真香（图文无关）-2021-05-01-00-33-17.jpeg)

> **作为订餐用户（简称：用户）：**
>
> - 可通过电子邮件、手机号码或微信账号注册账号并登录，也可永久注销个人账号。
> - 在登录后，可以利用该产品按照餐品分类、综合排序、距离远近、好评分数、配送速度、人均费用高低来浏览不同餐饮商家所上架的餐品。
> - 可将多家餐饮商家的餐品加入购物车，也可以直接下单，下单时以餐饮商家为单位单独下单。
> - 系统将根据配送距离计算配送费用，并加入订单支付总额。
> - 下单后5分钟内需要支付或取消订单，支付时如有优惠红包可以选择一个抵扣费用；若超时未支付，订单自动失效作废。
> - 用户可以使用支付宝、微信支付、银联支付或Apple Pay（仅支持苹果手机）进行支付。
> - 支付成功后10分钟内，餐饮商家将确认是否接单，若拒接订单或超时，订单将自动失效作废，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。
> - 商家接单后20分钟内，将备餐完毕。若超时，订餐用户可选择取消订单，订单取消后，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。
> - 商家备餐完毕后，骑手将会在系统计算的配送时间范围内进行取餐和配送，在此期间订餐用户无法取消订单。
> - 若超出配送时间15分钟，平台会提供一个优惠红包作为补偿。
> - 当骑手将餐品送达后，骑手会确认送达，订单交易完成。在交易完成后，餐饮用户可对商家和骑手做出评价。
> 
> **作为餐饮商家（简称：商家）**
>
> - 可通过电子邮件、手机号码注册账号并提供实名认证和营业资质信息，实名认证和营业资质审核通过后，将开通商家账号并可登录。商家也可永久注销账号。
> - 商家在账号登录后，可上架餐品信息并设置相关的价格及打包费用。也可下架餐品信息。
> - 系统将按商家的签约等级，计算服务费用，合并计入餐品价格。
> - 在商家接到客户支付成功的订单后10分钟内，需要确认是否接单，若拒接订单或超时，订单将自动失效作废。
> - 在商家接单后20分钟内，需备餐完毕并确认。若超时，订单用户可选择取消订单。
> - 在商家接单同时，系统会计算并分配最适合的骑手准备取餐。当备餐完毕确认后，骑手会确认取餐并予以配送。
> - 在取餐确认后，无论配送成功与否，商家账户均将收到扣减服务费后的订单结算费用。
> - 商家可每日申请一次账户提现，从账户余额中提取指定金额。
> 
> **作为骑手（简称：骑手）：**
> 
> - 这块儿业务功能不需要你关注，已经外包给了另外的合作方来开发，届时对接配送系统服务即可。

### 分析步骤

在8x Flow中，我们将利用以下两个关键活动（步骤），持续分析、梳理并将业务信息转化为`合约上下文（Contract Context）模型`进行表达：

1. 分析当事人和当事人间的合约关系
2. 基于履约活动分析并提取合约上下文

接下来，我们看看怎么做。

#### 第一步：分析当事人和当事人间的合约关系

由于不同的甲乙方所达成的合约，直接决定了不同的业务内容和权责关系。

那么，如果我们能够清晰地知道业务活动中的当事人（Parties）类型都有哪些，便可以较为容易的按照当事人的合约关系来快速识别较大粒度的业务边界。

从上述业务的描述中，我们可以看到在这个业务中存在以下四种不同类型的当事人：

- 平台
- 用户
- 商家
- 骑手

接下来我们就可以基于该业务描述，分析并寻找这四个当事人之间存在怎样的合约关系——换句话说，如果他们之间要通过签署合约的方式来描述相互之间的权利与责任的话，会签署哪些合约。

由于这个业务中是一个平台型产品，扮演的更多的是一种中间人的角色，那么实际上他们存在着以下三种合约关系：

- 用户 & 平台
- 商家 & 平台
- 骑手 & 平台（不关注）

![业务合约关系](https://huhao-dev.oss-cn-beijing.aliyuncs.com/业务合约关系-2021-05-01-00-10-29.png)

需要注意的是，在实际中，这种业务形态的设计是一定会由业务专家和法务专家基于合法性和权责关系进行设计的，并先于系统而出现的。（如果感兴趣的话，大家可以研究一下现在市面上类似的产品或服务，例如前面给大家提供的“饿了么”的合约文件）。所以在实际操作中，通常我们会采用正向和逆向两种方法来进行分析和识别：

1. 正向识别：通过已有的合约文件来识别。
2. 逆向识别：在没有合约文件的情况下，基于编写合约文件的视角，通过当事人之间的权责关系来分析或推断。

分析当事人的合约关系有一个显著的好处：**可以不需要通过复杂的流程分析，就能够快速识别出大致准确的业务上下文边界。**

提前识别了合约的上下文有什么样的好处呢？其实这里与DDD拥有一个共同的目的，就是识别概念差异并统一语言。

![合约边界即上下文边界](https://huhao-dev.oss-cn-beijing.aliyuncs.com/合约边界即上下文边界-2021-04-30-23-44-27.png)

#### 第二步：基于履约活动分析并提取合约上下文

权利和责任，合同上不关注的就不是
严格的双方合约视角

![订餐用户注册合约上下文](https://huhao-dev.oss-cn-beijing.aliyuncs.com/订餐用户注册合约上下文-2021-05-01-00-24-12.png)

![订餐服务合约上下文](https://huhao-dev.oss-cn-beijing.aliyuncs.com/订餐服务合约上下文-2021-05-01-00-24-12.png)

![餐品信息服务合约上下文](https://huhao-dev.oss-cn-beijing.aliyuncs.com/餐品信息服务合约上下文-2021-05-01-00-24-12.png)

![餐饮商家入驻合约上下文](https://huhao-dev.oss-cn-beijing.aliyuncs.com/餐饮商家入驻合约上下文-2021-05-01-00-24-12.png)

![餐品采购合约上下文](https://huhao-dev.oss-cn-beijing.aliyuncs.com/餐品采购合约上下文-2021-05-01-00-24-12.png)

### 过程回顾

## 结尾

> **内容声明：**“8x Flow业务建模法”为ThoughtWorks中国区CTO——徐昊先生研究并设计的原创方法论，本系列相关文章的目的是对外宣传和推广，并得到了徐昊本人的许可。文章内容为作者的个人理解和补充，如有偏差，相关权威解释以徐昊为准。

## 参考资料

- [《8x Flow 业务建模法（一）：你能分清业务和领域吗？》](/posts/2932e594/)
- [《8x Flow 业务建模法（二）：再看什么是业务逻辑》](/posts/a7c771dd/)
- [《深圳市住房和建设局关于启用新版《深圳市房屋租赁合同》示范文本的通知》](http://zjj.sz.gov.cn/xxgk/tzgg/content/post_6564773.html)
- [《饿了么用户服务协议》](https://render.alipay.com/p/f/fd-jb2xbzcl/index.html)
- [《饿了么网上订餐平台服务协议》](https://kaidian.ele.me/contract)
- [《饿了么蜂鸟众包配送协议》](https://talaris-h5.ele.me/agreement/agreement.html)

## 欢迎关注我的个人公众号

微信搜索：`枪炮与代码`，或者搜索公众号ID：`guns_n_code`

![枪炮与玫瑰](https://huhao-dev.oss-cn-beijing.aliyuncs.com/2020-01-20-wechat.png)
