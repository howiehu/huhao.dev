---
title: 8x Flow 业务建模法（三）：基于合约视角分析并提取业务逻辑
abbrlink: eda54f7
categories:
  - 软件工程实践
tags:
  - 业务建模
  - 8x Flow
  - 业务逻辑
---

## 前言

在上一篇[《8x Flow 业务建模法（二）：再看什么是业务逻辑》](/posts/a7c771dd/)中，我们对于什么是业务逻辑进行了再一次的说明和澄清，在这里回顾一下业务逻辑的关键特征：

> - **业务逻辑关注的是如何盈利的特定运营流程，对外关注的是如何通过提供商品或服务盈利，对内关注的是如何控制成本结构和绩效。**
> - **业务流程即业务凭证的追溯过程，业务凭证不可变且不可抛弃。**
> - **在现实中，业务活动作为企业运营的一部分，客观存在且受到合同法的保护，业务逻辑即合同范围内甲乙双方权责的履约过程。**

同时我们也再一次强调了业务逻辑的客观存在性：

> **业务逻辑具有天然的基于合约的法律约束，这一点是现实中的客观事实。领域逻辑则往往不涉及合同法的约束。**

另外，基于**“业务逻辑即合同范围内甲乙双方权责的履约过程“**这一特征，我们在上一篇中给出过一个围绕从合约产生到履约过程的一个抽象模型，即`合约上下文（Contract Context）模型`：

> `Request for Proposal` → `Proposal` → `Contract` → `Fulfillment Request` → `Fulfillment Confirmation`

模型的图像关系如下：

![合约上下文模型](https://huhao-dev.oss-cn-beijing.aliyuncs.com/合约上下文模型-2021-04-04-16-54-59.png)

同时，我们也对该模型，也就是合约上下文的关键活动过程（逻辑关系）做过解释：

> 1. 甲方先要进行`询价（Request for Proposal，简称RFP）`，然后乙方给出`报价（Proposal）`，随后双方根据报价方案签订`合约（Contract）`。
> 2. 合约签订之后，双方就会根据合约中的权责条款进行逐项`履约（Fulfillment）`。
> 3. 每次履约实际上分成了两类，一个是`履约申请（Fulfillment Request）`，一个是`履约确认（Fulfillment Confirmation）`，分别由甲乙双方的其中一方执行，其中履约申请是一个时间段，而履约确认是一个或多个时间点（因为履约总是需要个过程，不可能瞬间完成）。
> 4. 其中的`RFP、Proposal`、`Contract`、`Fulfillment Request`、`Fulfillment Confirmation`，都是`凭证（Evidence）`，所以是需要留存和可追溯的。

基于以上的业务逻辑相关知识，我们从本篇开始，将逐渐进入8x Flow的业务分析和建模方法介绍。

本篇说的就是8x Flow的第一步：**基于合约上下文（Contract Context）分析并提取业务逻辑**。

<!-- more -->

## 合约的概念

在我们开始业务分析和建模之前，非常有必要先审视一下**合约**的概念。

### 什么是合约？

在这里，**当我们说到“合约”一词的时候，目的是消除语言的二义性**，在现实的法务定义中，依据法律约束力的由弱至强，可以分为：

> - 协议（Agreement）：双方就业务安排中的权利和责任达成的一致理解。
> - 合同（Contract）：双方之间签署的具有法律约束力的协议（Agreement）。

换句话说：**合同（Contract）是一种特定类型的协议（Agreement），必要时可在法院强制执行。**

**不论是协议还是合同，一旦其发生了变更，都需要合同双方重新予以确认，以便达成新的业务权责关系，不同版本的协议和合同也代表了不同历史时期的业务**——这也是为什么我们在使用一些网站或APP的时候，过一段时间就会提醒某种协议变更，只有同意后才能继续使用的原因——因为业务中的某种权责关系发生了变化。（此外，因为往往这些是协议而不是合同，所以大多数只需勾选同意，而非签署正式合同，或做合同变更。）

***PS：在文章中，当不涉及需要精准表达的场景中（例如建模时的命名），我们会继续使用中文的“合约”一词代替“合同”或“协议”，从而统一语言。***

### 合约上都有什么？

合约上都有怎样的关键信息呢？我们用一个大家可能相对比较熟悉的房屋租赁合同来举例（这里用了一个较为严谨和规范的例子，由于受图片尺寸限制只能截取片段，完整版请见：[《深圳市房屋租赁合同书（住宅）》](http://zjj.sz.gov.cn/xxgk/tzgg/content/post_6564773.html)）：

![深圳市房屋租赁合同书（住宅）片段](https://huhao-dev.oss-cn-beijing.aliyuncs.com/深圳市房屋租赁合同书（住宅）-2021-04-18-13-25-38.png)

在众多法务用语和文字之中，有这样一些需要我们关注的关键的信息：

1. **当事人（Partis）**，即常说的甲乙方，限定了合同所涉及的自然人或法律实体（但需要注意的是甲乙方在法律意义上是平等的，并没有“甲方就是客户爸爸，乙方就是万年跪着”之说……）。如果是多方合约，在法律上都是看做两两构成的双方合约。
2. **条款（Clauses）**，描述了双方的权责关系和履约方式，还有一些履约所需要的关键信息，通常是：钱、时间、次数、物品、标准、场所……等等。条款所涉及的履约过程和活动，都应通过**凭证（Evidences）**进行证明和留存，并可通过凭证进行追溯。
3. **违约（Breach of Contract）**，描述了当发生违约之后双方的处理方式，同样是通过条款来进行细化，从业务分析和建模的角度来讲，往往容易被忽视，从而造成法律风险。

而我们接下来要进行的**8x Flow业务分析和建模过程的核心，就是关注并着重分析以上关键信息之间的逻辑关系和合理性，通过提取、分类、组合和抽象这些关键信息来实现的**。

### 基于合约视角 over 基于合约本身

这里需要注意的是：**在现实中，我们通常不太可能完全基于真实的合同或协议文件进行业务分析和建模。**主要原因是：

1. 真实的合约受限于编写者的认知水平和专业水平，合约编写的严谨程度会有不同，内容和实际业务可能存在差异，而且出于某些特殊原因，合约的内容可能存在一定的灰度地带。
2. 企业的业务部门和法务部门相互独立，法务部门更多的是为业务部门的业务设计提供法律保障，虽然合约上的条款反映了实际业务，但是合约毕竟不是业务说明书，文本的应用场景不同，所以仅供作为一种关键的业务输入。

**了解并学习合同知识，目的是为了我们基于业务的法律属性和权责关系，更好的理解、梳理并设计出更加严谨和合理的业务，或者寻找业务设计上可能存在的权责不匹配所造成的业务或法务漏洞。**从不同的角色来看：

- 对于一个法务人员来说，如果能够非常清晰的知道以上知识，则能够制定更加严谨的合同文本。
- 对于一个业务人员来说，如果能够非常清晰的知道以上知识，则能够设计更严谨和合理的业务。
- 对于一个技术人员来说，如果能够非常清晰的知道以上知识，则能够更好的理解业务，并设计出更加符合业务要求的软件。

## 分析并提取业务逻辑

既然我们需要基于合约视角进行业务分析和建模，那么为了便于后续的分析和讲解，下面我给出一个经过简化的基于合约描述的虚拟案例（业务说明）：

*（PS：该案例纯用于文章写作，并不保证业务完备性，如有类同，纯属巧合。）*

### 参考业务说明

**某互联网订餐平台——“吃了么”（公司名称：吃了么您呐网络科技有限公司，简称：吃了么您呐），寻找供应商协助完成产品开发**，通过手机APP（iOS、Android）、微信小程序、Web应用作为用户触点，达成其业务目标。该公司对该产品有如下期望（图文无关，手动狗头）：

![图文无关](https://huhao-dev.oss-cn-beijing.aliyuncs.com/真香（图文无关）-2021-04-18-15-33-38.jpeg)

> **作为订餐用户：**
>
> - 可通过电子邮件、手机号码或微信账号注册账号并登录，也可永久注销个人账号并删除所有个人相关数据。
> - 在登录后，可以利用该产品按照餐品分类、综合排序、距离远近、好评分数、配送速度、人均费用高低来浏览不同餐饮商家所上架的餐品。
> - 可将多家餐饮商家的餐品加入购物车，并且在账号下一次登录后依然可用；也可以直接下单。
> - 下单时以餐饮商家为单位单独下单，不提供通过购物车一次性全部下单的功能。
> - 系统将根据配送距离计算配送费用，并加入订单支付总额。
> - 下单后5分钟内需要支付或取消订单，支付时如有优惠红包可以选择一个抵扣费用；若超时未支付，订单自动失效作废。
> - 用户可以使用支付宝、微信支付、银联支付或Apple Pay（仅支持苹果手机）进行支付。
> - 支付成功后10分钟内，餐饮商家将确认是否接单，若拒接订单或超时，订单将自动失效作废，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。
> - 商家接单后20分钟内，将备餐完毕。若超时，订餐用户可选择取消订单，订单取消后，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。
> - 商家备餐完毕后，骑手将会在系统计算的配送时间范围内进行取餐和配送，在此期间订餐用户无法取消订单。
> - 若超出配送时间15分钟后，订餐用户可选择取消订单，订单取消后，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。同时，平台还会提供一个优惠红包作为补偿。
> - 当骑手将餐品送达后，骑手会确认送达，订单交易完成。在交易完成后，餐饮用户可对商家和骑手做出评价。
> - 若出现任何过程纠纷，订餐用户可在系统内联络24小时在线客服予以协助处理，系统会对该过程进行记录和录音留作未来持续跟踪处理。
> 
> **作为餐饮商家：**
>
> - 可通过电子邮件、手机号码注册账号并提供实名认证和营业资质信息，实名认证和营业资质审核通过后，将开通商家账号并可登录。商家也可永久注销账号，并删除法律规定留存的关键凭证信息以外的数据。
> - 商家在账号登录后，需缴存3万元押金，押金缴纳成功后，可上架餐品信息并设置相关的价格及打包费用。也可下架餐品信息。
> - 押金缴纳支持企业对公转账，或银联支付，暂不支持支付宝和微信等支付渠道若在合作过程中，商家违反相关合作协议，所缴纳押金将依据相关约定予以扣减，当押金全部扣减之后商家将无法接受任何新的客户订单，且需接受服务情况调查。若商家正常注销，剩余押金将按原支付渠道退还。
> - 系统将按商家的签约等级，计算服务费用，合并计入餐品价格。
> - 在商家接到客户支付成功的订单后10分钟内，需要确认是否接单，若拒接订单或超时，订单将自动失效作废。
> - 在商家接单后20分钟内，需备餐完毕并确认。若超时，订单用户可选择取消订单。
> - 在商家接单同时，系统会计算并分配最适合的骑手准备取餐。当备餐完毕确认后，骑手会确认取餐并予以配送。
> - 在取餐确认后，无论配送成功与否，商家账户均将收到扣减服务费后的订单结算费用。
> - 若出现客户针对订单的投诉，客服部门将依据客户投诉类型和协议约定予以处理，并决定是否从商家账户中扣减相应的已入账金额。
> - 商家可每日申请一次账户提现，从账户余额中提取指定金额。
> 
> **作为骑手：**
> 
> - 这块儿业务功能不需要你关注，已经外包给了另外的合作方来开发，届时对接配送系统服务即可。

### 分析步骤

在8x Flow中，我们将利用以下几个关键活动（步骤），持续分析、梳理并将业务信息转化为`合约上下文（Contract Context）模型`进行表达：

1. 分析当事人和合约关系
2. 识别履约活动和三方能力
3. 依据凭证分离业务和领域逻辑
4. 按业务相关性分类
5. 构建合约上下文模型
6. 补全关键履约项

接下来，我们将一步一步的对前述的“吃了么”业务进行分析。

#### 第一步：分析当事人和合约关系

```markdown
# 当事人

- 订餐用户
- 餐饮商家
- 骑手
- 吃了么您呐
```

```markdown
# 合约关系

- 订餐用户 & 吃了么您呐
- 餐饮商家 & 吃了么您呐
- 骑手 & 吃了么您呐（不关注）
```

#### 第二步：识别履约活动和三方能力

> **作为订餐用户：**
>
> - 可通过电子邮件、手机号码或微信账号`注册账号并登录`，也可`永久注销个人账号并删除所有个人相关数据`。
> - `在登录后`，可以利用该产品按照餐品分类、综合排序、距离远近、好评分数、配送速度、人均费用高低来`浏览不同餐饮商家所上架的餐品`。
> - `可将多家餐饮商家的餐品加入购物车，并且在账号下一次登录后依然可用`；`也可以直接下单`。
> - `下单时以餐饮商家为单位单独下单`，`不提供通过购物车一次性全部下单的功能`。
> - 系统`将根据配送距离计算配送费用`，`并加入订单支付总额`。
> - `下单后5分钟内需要支付或取消订单`，`支付时如有优惠红包可以选择一个抵扣费用`；`若超时未支付，订单自动失效作废`。
> - 用户可以使用支付宝、微信支付、银联支付或Apple Pay（仅支持苹果手机）`进行支付`。
> - `支付成功后10分钟内，餐饮商家将确认是否接单`，`若拒接订单或超时，订单将自动失效作废`，`订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款`，`若使用了优惠红包，也会一并退回用户账户`。
> - `商家接单后20分钟内，将备餐完毕`。`若超时，订餐用户可选择取消订单`，订单取消后，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。
> - `商家备餐完毕后，骑手将会在系统计算的配送时间范围内进行取餐和配送`，`在此期间订餐用户无法取消订单`。
> - `若超出配送时间15分钟后，订餐用户可选择取消订单`，订单取消后，订餐用户已支付的费用将在5分钟内通过原支付渠道进行退款，若使用了优惠红包，也会一并退回用户账户。同时，平台还会提供一个优惠红包作为补偿。
> - `当骑手将餐品送达后，骑手会确认送达，订单交易完成`。`在交易完成后，餐饮用户可对商家和骑手做出评价`。
> - `若出现任何过程纠纷，订餐用户可在系统内联络24小时在线客服予以协助处理`，`系统会对该过程进行记录和录音留作未来持续跟踪处理`。

```markdown
甲方：订餐用户
乙方：吃了么您呐

- 注册账号
- 登录账号
- 注销账号
- 删除账号数据
- 浏览上架餐品
- 加入购物车
- 下单
- 计算配送费用
- 支付订单
- 取消订单
- 优惠红包抵扣
- 订单失效
- 接单
- 退款
- 退还优惠红包
- 备餐
- 取餐
- 配送
- 送达
- 评价商家
- 评价骑手
- 客户投诉
- 客户投诉记录
```
 
> **作为餐饮商家：**
>
> - 可通过电子邮件、手机号码`注册账号并提供实名认证和营业资质信息`，`实名认证和营业资质审核通过后，将开通商家账号并可登录`。`商家也可永久注销账号，并删除法律规定留存的关键凭证信息以外的数据`。
> - 商家`在账号登录后，需缴存3万元押金`，`押金缴纳成功后，可上架餐品信息`并设置相关的价格及打包费用。`也可下架餐品信息`。
> - 押金缴纳支持企业对公转账，或银联支付，暂不支持支付宝和微信等支付渠道。若在合作过程中，`商家违反相关合作协议，所缴纳押金将依据相关约定予以扣减`，`当押金全部扣减之后商家将无法接受任何新的客户订单，且需接受服务情况调查`。`若商家正常注销，剩余押金将按原支付渠道退还`。
> - 系统将`按商家的签约等级，计算服务费用，合并计入餐品价格`。
> - `在商家接到客户支付成功的订单后10分钟内，需要确认是否接单`，`若拒接订单或超时，订单将自动失效作废`。
> - `在商家接单后20分钟内，需备餐完毕并确认`。`若超时，订单用户可选择取消订单`。
> - `在商家接单同时，系统会计算并分配最适合的骑手准备取餐`。`当备餐完毕确认后，骑手会确认取餐并予以配送`。
> - `在取餐确认后，无论配送成功与否，商家账户均将收到扣减服务费后的订单结算费用`。
> - `若出现客户针对订单的投诉，客服部门将依据客户投诉类型和协议约定予以处理`，`并决定是否从商家账户中扣减相应的已入账金额`。
> - `商家可每日申请一次账户提现，从账户余额中提取指定金额`。

```markdown
甲方：餐饮商家
乙方：吃了么您呐

- 注册账号
- 实名认证
- 营业资质审核
- 开通账号
- 登录账号
- 注销账号
- 删除账号数据
- 缴纳押金
- 上架餐品
- 下架餐品
- 扣减押金
- 调查服务情况
- 退还押金
- 计算餐品服务费
- 接单
- 备餐
- 取消订单
- 分配骑手
- 取餐
- 配送
- 扣减服务费
- 订单结算
- 投诉处理
- 扣减已入账金额
- 账户提现
```

> **作为骑手：**
> 
> - 这块儿业务功能不需要你关注，已经外包给了另外的合作方来开发，`届时对接配送系统服务即可`。


### 过程回顾

## 结尾

> **内容声明：**“8x Flow业务建模法”为ThoughtWorks中国区CTO——徐昊先生研究并设计的原创方法论，本系列相关文章的目的是对外宣传和推广，并得到了徐昊本人的许可。文章内容为作者的个人理解和补充，如有偏差，相关权威解释以徐昊为准。

## 参考资料

- [《8x Flow 业务建模法（一）：你能分清业务和领域吗？》](/posts/2932e594/)
- [《8x Flow 业务建模法（二）：再看什么是业务逻辑》](/posts/a7c771dd/)
- [《深圳市住房和建设局关于启用新版《深圳市房屋租赁合同》示范文本的通知》](http://zjj.sz.gov.cn/xxgk/tzgg/content/post_6564773.html)

## 欢迎关注我的个人公众号

微信搜索：`枪炮与代码`，或者搜索公众号ID：`guns_n_code`

![枪炮与玫瑰](https://huhao-dev.oss-cn-beijing.aliyuncs.com/2020-01-20-wechat.png)
